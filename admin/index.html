<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleka Taxi | Admin Dashboard</title>
    <link rel="icon" href="../ims/1110.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2549eb;
            --primary-dark: #1d26d8;
            --secondary: #f59e0b;
            --accent: #10b981;
            --danger: #ef4444;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #f9fafb;
            --bg-secondary: #f3f4f6;
            --bg-tertiary: #e5e7eb;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 10px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            transition: var(--transition);
            text-decoration: none;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .sidebar-nav i {
            width: 20px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .header h1 {
            font-size: 2rem;
            color: var(--text);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

            /* Auth modal styles (shared) */
            .auth-backdrop { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(2,6,23,0.55); z-index: 2000; }
            .auth-modal { width: 440px; max-width: 94%; border-radius: 12px; background: #fff; box-shadow: 0 10px 30px rgba(2,6,23,0.3); overflow: hidden; }
            .auth-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--border); }
            .auth-title { font-size:1.1rem; font-weight:700; }
            .auth-close { background:none; border:none; font-size:1.1rem; cursor:pointer; color:var(--text-light); }
            .auth-body { padding:18px 20px; }
            .auth-tabs { display:flex; gap:8px; margin-bottom:14px; }
            .auth-tab { flex:1; text-align:center; padding:8px 10px; border-radius:8px; cursor:pointer; background:var(--bg-secondary); color:var(--text); font-weight:600; }
            .auth-tab.active { background:var(--primary); color:#fff; }
            .auth-form { display:block; }
            .auth-form .form-group { margin-bottom:12px; }
            .auth-body .form-group { position: relative; }
            .password-toggle { position: absolute; right: 10px; top: 38px; background: none; border: none; font-size: 1rem; cursor: pointer; color: var(--text-light); padding: 4px; }
            .auth-body .form-group input { padding-right: 44px; }
            .auth-form label { display:block; font-size:0.85rem; margin-bottom:6px; color:var(--text-light); }
            .auth-form input { width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); background:transparent; color:inherit; }
            .auth-actions { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px; }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            font-size: 0.95rem;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: #e69500;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-success {
            background-color: var(--accent);
        }

        .btn-success:hover {
            background-color: #059669;
        }

        /* Stats Section */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .stat-card.clickable { cursor: pointer; }
        .stat-card.clickable:hover { transform: translateY(-6px); box-shadow: 0 10px 20px rgba(0,0,0,0.12); }
        .stat-card.active { outline: 3px solid rgba(37,73,235,0.08); }

        .stat-content h3 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-icon {
            font-size: 2.5rem;
            color: var(--primary);
            opacity: 0.2;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 73, 235, 0.1);
        }

        /* Bookings Table */
        .bookings-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            font-size: 1.3rem;
            color: var(--text);
        }

        .table-header .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 6px;
        }

        .table-header input[type="search"] {
            border: none;
            background: none;
            outline: none;
            width: 200px;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--bg-secondary);
            border-bottom: 2px solid var(--border);
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        tbody tr:hover {
            background-color: var(--bg-secondary);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-confirmed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-completed {
            background-color: #dbeafe;
            color: #0c2d6b;
        }

        .badge-cancelled {
            background-color: #fee2e2;
            color: #7f1d1d;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .action-btn-view {
            background-color: var(--primary);
            color: white;
        }

        .action-btn-view:hover {
            background-color: var(--primary-dark);
        }

        .action-btn-delete {
            background-color: var(--danger);
            color: white;
        }

        .action-btn-delete:hover {
            background-color: #dc2626;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h2 {
            color: var(--text);
            font-size: 1.5rem;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .detail-group {
            margin-bottom: 15px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-value {
            color: var(--text);
            font-size: 0.95rem;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--text);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }

            .sidebar-header h2,
            .sidebar-nav span {
                display: none;
            }

            .main-content {
                margin-left: 80px;
                padding: 20px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .header-actions {
                flex-direction: column;
                width: 100%;
            }

            .header-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-group input,
            .filter-group select {
                width: 100%;
            }

            .table-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .table-header .search-box {
                width: 100%;
            }

            .table-header input[type="search"] {
                width: 100%;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px 8px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            /* Responsive table: collapse into stacked cards on small screens */
            .bookings-table-container table,
            .bookings-table-container thead,
            .bookings-table-container tbody,
            .bookings-table-container th,
            .bookings-table-container td,
            .bookings-table-container tr {
                display: block;
            }

            .bookings-table-container thead {
                display: none;
            }

            .bookings-table-container tbody tr {
                background: white;
                margin-bottom: 12px;
                border-radius: 8px;
                padding: 10px;
                box-shadow: var(--shadow);
            }

            .bookings-table-container td {
                padding: 8px 10px;
                border: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .bookings-table-container td::before {
                content: attr(data-label);
                display: inline-block;
                font-weight: 700;
                color: var(--text-light);
                margin-right: 12px;
                text-transform: uppercase;
                font-size: 0.75rem;
                flex: 0 0 40%;
            }

            .bookings-table-container td > * {
                flex: 1 1 auto;
                text-align: right;
            }

            .bookings-table-container .action-buttons {
                justify-content: flex-end;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../ims/1110.png" alt="Teleka Logo">
                <h2>Teleka</h2>
            </div>
            <nav>
                <ul class="sidebar-nav">
                    <li>
                        <a href="#" class="active" data-page="dashboard">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="bookings">
                            <i class="fas fa-calendar-check"></i>
                            <span>Bookings</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="analytics">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li>
                            <a href="../client/" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                            <i class="fas fa-arrow-left"></i>
                            <span>Back to Site</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Admin Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="exportBtn">
                        <i class="fas fa-download"></i>
                        Export Data
                    </button>
                    <button class="btn btn-danger" id="clearBtn">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                    
                    <button type="button" class="btn btn-outline" id="loginBtn">Login</button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboardSection">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card" id="totalCard" data-status="all">
                        <div class="stat-content">
                            <h3>Total Bookings</h3>
                            <div class="stat-value" id="totalBookings">0</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable" id="pendingCard" data-status="pending">
                        <div class="stat-content">
                            <h3>Pending</h3>
                            <div class="stat-value" id="pendingBookings">0</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-hourglass-start"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable" id="confirmedCard" data-status="confirmed">
                        <div class="stat-content">
                            <h3>Confirmed</h3>
                            <div class="stat-value" id="confirmedBookings">0</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable" id="completedCard" data-status="completed">
                        <div class="stat-content">
                            <h3>Completed</h3>
                            <div class="stat-value" id="completedBookings">0</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                    </div>
                </div>

                <!-- Bookings Table -->
                <div class="bookings-table-container">
                    <div class="table-header">
                        <h2>Recent Bookings</h2>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="search" id="searchInput" placeholder="Search by name or email...">
                        </div>
                    </div>

                    <div id="tableContent">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Pickup</th>
                                    <th>Destination</th>
                                    <th>Date & Time</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analyticsSection" style="display: none;">
                <div class="stat-card" style="grid-column: 1/-1;">
                    <h2>Analytics Coming Soon</h2>
                </div>
            </section>
        </main>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Booking Details</h2>
            </div>
            <div class="modal-body" id="detailModalBody">
            </div>
            <div class="modal-footer">
                        <button class="btn btn-success" id="confirmBtn" style="display:none;" onclick="confirmBooking()">Confirm</button>
                        <button class="btn" onclick="closeDetailModal()">Close</button>
            </div>
        </div>
    </div>

        <script>
                let allBookings = [];
        let currentDetailId = null;
        let currentFilter = null; // null | 'pending' | 'confirmed' | 'completed'

        // Load bookings from server
        async function loadBookings() {
            try {
                const response = await fetch('/api/bookings');
                if (!response.ok) throw new Error('Failed to load bookings');
                // detect new bookings by comparing latest createdAt
                const bookingsArr = await response.json();
                const prevLatest = window.__lastBookingTime || 0;
                const newLatest = bookingsArr.reduce((m, b) => {
                    const t = Date.parse(b.createdAt || 0) || 0; return Math.max(m, t);
                }, 0);
                window.__lastBookingTime = newLatest;
                allBookings = bookingsArr;
                // apply status filter if active
                if (currentFilter && currentFilter !== 'all') {
                    const filtered = allBookings.filter(b => (b.status || 'pending').toLowerCase() === currentFilter);
                    renderBookings(filtered);
                } else {
                    renderBookings(allBookings);
                }
                updateStats();
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsTableBody').innerHTML = `
                    <tr><td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <h3>Error Loading Bookings</h3>
                            <p>${error.message}</p>
                        </div>
                    </td></tr>
                `;
            }
        }

        // Render bookings table
        function renderBookings(bookings) {
            const tbody = document.getElementById('bookingsTableBody');
            if (bookings.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No Bookings Yet</h3>
                            <p>Bookings will appear here when customers submit the form.</p>
                        </div>
                    </td></tr>
                `;
                return;
            }

            tbody.innerHTML = bookings.map((booking, index) => `
                <tr>
                    <td data-label="Name"><strong>${booking.name}</strong></td>
                    <td data-label="Phone">${booking.phone || 'N/A'}</td>
                    <td data-label="Pickup">${booking.pickup}</td>
                    <td data-label="Destination">${booking.destination}</td>
                    <td data-label="Date & Time">${formatDateTime(booking.date, booking.time)}</td>
                    <td data-label="Service">${booking.serviceType}</td>
                    <td data-label="Status"><span class="badge badge-${booking.status || 'pending'}">${booking.status || 'Pending'}</span></td>
                    <td data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn action-btn-view" onclick="viewDetailById('${booking._id}')">View</button>
                            <button class="action-btn action-btn-delete" onclick="deleteBookingById('${booking._id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update statistics
        function updateStats() {
            const stats = {
                total: allBookings.length,
                pending: allBookings.filter(b => !b.status || b.status === 'pending').length,
                confirmed: allBookings.filter(b => b.status === 'confirmed').length,
                completed: allBookings.filter(b => b.status === 'completed').length
            };

            document.getElementById('totalBookings').textContent = stats.total;
            document.getElementById('pendingBookings').textContent = stats.pending;
            document.getElementById('confirmedBookings').textContent = stats.confirmed;
            document.getElementById('completedBookings').textContent = stats.completed;
        }

        // View booking details
        function viewDetailById(id) {
            const idx = allBookings.findIndex(b => b._id === id);
            if (idx === -1) return alert('Booking not found');
            const booking = allBookings[idx];
            const modal = document.getElementById('detailModal');
            const body = document.getElementById('detailModalBody');

            body.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">${booking.name}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Phone</div>
                    <div class="detail-value">${booking.phone || 'Not provided'}</div>
                </div>
                <!-- WhatsApp removed from booking details -->
                <div class="detail-group">
                    <div class="detail-label">Pickup Location</div>
                    <div class="detail-value">${booking.pickup}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Destination</div>
                    <div class="detail-value">${booking.destination}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Service Type</div>
                    <div class="detail-value">${booking.serviceType}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Date</div>
                    <div class="detail-value">${booking.date}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Time</div>
                    <div class="detail-value">${booking.time}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Estimated Price</div>
                    <div class="detail-value">${booking.estimatedPrice || 'N/A'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Booking Date</div>
                    <div class="detail-value">${new Date(booking.createdAt).toLocaleString()}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Status</div>
                    <div class="detail-value"><span class="badge badge-${booking.status || 'pending'}">${booking.status || 'Pending'}</span></div>
                </div>
            `;
            // store current id for actions like confirm/delete
            currentDetailId = id;
            // show/hide confirm button depending on status
            const confirmBtn = document.getElementById('confirmBtn');
            if (confirmBtn) {
                confirmBtn.style.display = (booking.status && booking.status.toLowerCase() === 'pending') ? 'inline-flex' : 'none';
            }
            modal.classList.add('open');
        }

        // Close detail modal
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('open');
        }

        // Delete booking by id
        async function deleteBookingById(id) {
            if (!confirm('Are you sure you want to delete this booking?')) return;
            try {
                const idx = allBookings.findIndex(b => b._id === id);
                const bookingId = id;
                const response = await fetch(`/api/bookings/${bookingId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete booking');
                if (idx !== -1) allBookings.splice(idx, 1);
                renderBookings(allBookings);
                updateStats();
                alert('Booking deleted successfully!');
            } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Error deleting booking: ' + (error && error.message));
            }
        }

        // Confirm booking (mark as confirmed)
        async function confirmBooking() {
            try {
                if (!currentDetailId) return;
                const id = currentDetailId;
                const idx = allBookings.findIndex(b => b._id === id);
                const booking = (idx !== -1) ? allBookings[idx] : null;
                if (!booking) return alert('Booking not found');
                if (!confirm('Confirm this booking?')) return;

                const bookingId = booking._id || id;
                const response = await fetch(`/api/bookings/${bookingId}/confirm`, { method: 'POST' });
                if (!response.ok) {
                    const txt = await response.text().catch(()=>null);
                    throw new Error('Failed to confirm booking' + (txt ? (': '+txt) : ''));
                }
                const updated = await response.json();
                // update local state
                if (idx !== -1) allBookings[idx] = updated;
                renderBookings(allBookings);
                updateStats();
                // update modal status badge
                const confirmBtn = document.getElementById('confirmBtn');
                if (confirmBtn) confirmBtn.style.display = 'none';
                // refresh modal contents to show updated status
                viewDetailById(bookingId);
                alert('Booking confirmed');
            } catch (error) {
                console.error('Error confirming booking:', error);
                alert('Error confirming booking: ' + (error && error.message));
            }
        }

        // Export bookings as JSON
        function exportBookings() {
            const dataStr = JSON.stringify(allBookings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bookings-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Clear all bookings
        function clearAllBookings() {
            if (!confirm('Are you sure? This will delete ALL bookings permanently!')) return;

            fetch('/api/bookings/clear-all', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    allBookings = [];
                    renderBookings(allBookings);
                    updateStats();
                    alert('All bookings cleared!');
                }
            }).catch(error => console.error('Error clearing bookings:', error));
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            // start from allBookings, but respect current status filter
            let base = allBookings;
            if (currentFilter && currentFilter !== 'all') {
                base = allBookings.filter(b => (b.status || '').toLowerCase() === currentFilter);
            }
            const filtered = base.filter(b =>
                (b.name || '').toLowerCase().includes(query) ||
                ((b.email || '') && b.email.toLowerCase().includes(query))
            );
            renderBookings(filtered);
        });

        // Stat card click handlers
        function applyStatFilter(status) {
            currentFilter = status || null;
            // update active visual state
            ['totalCard','pendingCard','confirmedCard','completedCard'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('active', (id === 'totalCard' && !currentFilter) || (el.dataset.status === currentFilter));
            });
            // re-render using loadBookings' filtering logic (but avoid refetch)
            if (currentFilter && currentFilter !== 'all') {
                const filtered = allBookings.filter(b => (b.status || '').toLowerCase() === currentFilter);
                renderBookings(filtered);
            } else {
                renderBookings(allBookings);
            }
            // On small screens, bring the bookings table (and first row) to the top
            try {
                if (window.innerWidth <= 768) {
                    const tableContent = document.getElementById('tableContent');
                    if (tableContent) {
                        tableContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // after a short delay, ensure first row is visible at top
                        setTimeout(() => {
                            const firstRow = document.querySelector('#bookingsTableBody tr');
                            if (firstRow) firstRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 260);
                    }
                }
            } catch (e) { /* ignore scrolling errors */ }
        }

        // attach handlers once DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            ['totalCard','pendingCard','confirmedCard','completedCard'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('click', () => {
                    const s = el.dataset.status === 'all' ? null : el.dataset.status;
                    applyStatFilter(s);
                });
            });
            // set initial active visual state (total)
            applyStatFilter(null);

            // wire export and clear buttons safely
            const exportBtn = document.getElementById('exportBtn');
            const clearBtn = document.getElementById('clearBtn');
            if (exportBtn) exportBtn.addEventListener('click', exportBookings);
            if (clearBtn) clearBtn.addEventListener('click', clearAllBookings);
            // wire enable sound button (default ON unless manually turned off)
            
        });

        // Format date and time
        function formatDateTime(date, time) {
            return `${date} ${time}`;
        }

        // Close modal when clicking outside
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') closeDetailModal();
        });

        

        

        // Navigation
        document.querySelectorAll('[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.currentTarget.dataset.page;
                
                document.querySelectorAll('[data-page]').forEach(l => l.classList.remove('active'));
                e.currentTarget.classList.add('active');

                document.getElementById('dashboardSection').style.display = page === 'dashboard' ? 'block' : 'none';
                document.getElementById('analyticsSection').style.display = page === 'analytics' ? 'block' : 'none';
            });
        });

        // Load bookings on page load
        loadBookings();

        // Auto-refresh every 10 seconds
        setInterval(loadBookings, 10000);

        // Server-Sent Events / sound notifications removed
    </script>

    <!-- Auth Modal -->
    <div class="auth-backdrop" id="authBackdrop" aria-hidden="true">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
            <div class="auth-header">
                <div class="auth-title" id="authTitle">Welcome</div>
                <button class="auth-close" id="authClose" aria-label="Close">&times;</button>
            </div>
            <div class="auth-body">
                <div class="auth-tabs" role="tablist">
                    <div class="auth-tab active" data-target="login" role="tab">Login</div>
                </div>

                <form class="auth-form" id="loginForm" data-form="login" autocomplete="off" spellcheck="false" novalidate>
                    <div class="form-group">
                        <label for="loginEmail">Phone or Admin ID</label>
                        <input id="loginEmail" name="identifier" type="text" placeholder="2567xxxxxxx or admin" required autocomplete="off" autocapitalize="none" autocorrect="off">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                            <input id="loginPassword" name="password" type="password" placeholder="••••••••" required autocomplete="new-password" autocapitalize="none" autocorrect="off">
                            <button type="button" class="password-toggle" data-target="loginPassword" aria-label="Show password"><i class="fas fa-eye"></i></button>
                    </div>
                    <div class="auth-actions">
                        <button class="btn" type="submit">Sign In</button>
                        <a href="#" class="auth-aux" id="forgotLink">Forgot?</a>
                    </div>
                </form>

                <form class="auth-form" id="profileForm" data-form="profile" style="display:none;">
                    <div class="form-group">
                        <label>Full name</label>
                        <input id="pfName" type="text" readonly>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input id="pfPhone" type="text" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input id="pfEmail" type="email" readonly>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input id="pfPassword" type="password" value="********" readonly>
                        <button type="button" class="password-toggle" data-target="pfPassword" aria-label="Show password"><i class="fas fa-eye"></i></button>
                    </div>
                    <div class="auth-actions">
                        <button class="btn btn-danger" type="button" id="pfLogout">Logout</button>
                        <button class="btn btn-secondary" type="button" id="pfClose">Close</button>
                    </div>
                </form>
                <!-- Registration removed for admin dashboard; admin users managed server-side -->
            </div>
        </div>
    </div>

    <script>
        (function(){
            const openBtn = document.getElementById('loginBtn');
            const backdrop = document.getElementById('authBackdrop');
            const closeBtn = document.getElementById('authClose');
            const tabs = Array.from(document.querySelectorAll('.auth-tab'));
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            let authError = document.getElementById('authError');
            if(!authError){
                authError = document.createElement('div');
                authError.id = 'authError';
                authError.className = 'auth-error';
                authError.style.display = 'none';
                authError.style.color = '#ef4444';
                authError.style.marginBottom = '10px';
                const body = document.querySelector('.auth-body');
                body.insertBefore(authError, body.firstChild);
            }

            function showModal(tab){
                backdrop.style.display = 'flex';
                backdrop.setAttribute('aria-hidden','false');
                document.body.style.overflow = 'hidden';
                setActiveTab(tab || 'login');
                clearError();
            }

            function closeModal(){
                backdrop.style.display = 'none';
                backdrop.setAttribute('aria-hidden','true');
                document.body.style.overflow = '';
            }

            function setActiveTab(name){
                tabs.forEach(t => {
                    const target = t.getAttribute('data-target');
                    if(target === name){ t.classList.add('active'); }
                    else { t.classList.remove('active'); }
                });
                const profileForm = document.getElementById('profileForm');
                const titleEl = document.getElementById('authTitle');
                const tabsContainer = document.querySelector('.auth-tabs');
                if(name === 'login'){
                    if(titleEl) titleEl.textContent = 'Welcome';
                    if(tabsContainer) tabsContainer.style.display = '';
                    loginForm.style.display = 'block'; if(profileForm) profileForm.style.display = 'none';
                } else if(name === 'profile'){
                    if(titleEl) titleEl.textContent = 'Welcome to your profile';
                    if(tabsContainer) tabsContainer.style.display = 'none';
                    loginForm.style.display = 'none'; if(profileForm) profileForm.style.display = 'block'; populateProfile();
                } else {
                    if(titleEl) titleEl.textContent = 'Welcome';
                    if(tabsContainer) tabsContainer.style.display = '';
                    loginForm.style.display = 'none'; if(profileForm) profileForm.style.display = 'none';
                }
                clearError();
            }

            function clearError(){ authError.style.display = 'none'; authError.textContent = ''; }
            function showError(msg){ authError.textContent = msg || 'An error occurred'; authError.style.display = 'block'; }

            async function postJSON(url, data){
                try{
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    let json = null;
                    try{ json = await res.json(); } catch(e) { json = null; }
                    return { ok: res.ok, status: res.status, json };
                } catch(err){
                    return { ok: false, error: err };
                }
            }

            function updateAuthUI(){
                try{
                    const raw = localStorage.getItem('authUser');
                    if(!raw){
                        openBtn.textContent = 'Login';
                        openBtn.classList.remove('user-btn');
                        openBtn.setAttribute('aria-label','Open login');
                        return;
                    }
                    const user = JSON.parse(raw);
                    const display = (user && (user.name || user.phone)) ? (user.name || user.phone) : 'Account';
                    openBtn.textContent = display;
                    openBtn.classList.add('user-btn');
                    openBtn.setAttribute('aria-label','User menu');
                }catch(e){
                    openBtn.textContent = 'Login';
                    openBtn.classList.remove('user-btn');
                }
            }

            // Lock/Unlock admin UI until admin authenticates
            function lockAdminUI(){
                const container = document.querySelector('.admin-container');
                if(container){ container.style.display = 'none'; }
            }
            function unlockAdminUI(){
                const container = document.querySelector('.admin-container');
                if(container){ container.style.display = 'flex'; }
            }

            function isAuthenticatedAdmin(){
                try{
                    const token = localStorage.getItem('authToken');
                    const raw = localStorage.getItem('authUser');
                    if(!token || !raw) return false;
                    const user = JSON.parse(raw);
                    if(user && user.role === 'admin') return true;
                }catch(e){ }
                return false;
            }

            // click handler: if not authenticated, open login modal; if authenticated, open profile modal
            openBtn?.addEventListener('click', function(e){
                e.preventDefault();
                try{
                    const raw = localStorage.getItem('authUser');
                    if(!raw){ showModal('login'); return; }
                    showModal('profile');
                }catch(err){ showModal('login'); }
            });

            // initialize
            updateAuthUI();

            // sound/notification controls removed

            // Clear login inputs to avoid browser autofill values and ensure no prefilled credentials
            try{
                const e = document.getElementById('loginEmail');
                const p = document.getElementById('loginPassword');
                if(e) { e.value = ''; }
                if(p) { p.value = ''; }
            }catch(e){}

            // Immediately lock UI if not authenticated admin, and show login modal on load
            if(!isAuthenticatedAdmin()){
                lockAdminUI();
                // show modal after a short tick to ensure backdrop element exists
                setTimeout(() => { try{ showModal('login'); }catch(e){} }, 50);
            } else {
                unlockAdminUI();
            }
            closeBtn?.addEventListener('click', closeModal);
            backdrop?.addEventListener('click', function(e){ if(e.target === backdrop) closeModal(); });
            tabs.forEach(t => t.addEventListener('click', () => setActiveTab(t.getAttribute('data-target'))));

            loginForm?.addEventListener('submit', async function(e){
                e.preventDefault();
                clearError();
                const submitBtn = loginForm.querySelector('button[type=submit]');
                const origText = submitBtn.textContent;
                submitBtn.textContent = 'Signing in...';
                submitBtn.disabled = true;

                const identifier = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                if(!identifier || !password){ showError('Please enter both identifier and password'); submitBtn.textContent = origText; submitBtn.disabled = false; return; }

                console.log('[LOGIN] Attempting login with identifier:', identifier);
                const res = await postJSON('/api/auth/login', { identifier, password });
                console.log('[LOGIN] Response:', { ok: res.ok, status: res.status, json: res.json });
                
                if(res.ok && res.json && res.json.token){
                    // Only allow admin account to sign in on this page
                    const user = res.json.user || {};
                    const isAdmin = (user.role === 'admin');
                    console.log('[LOGIN] User role:', user.role, 'Is admin:', isAdmin);
                    
                    if(!isAdmin){
                        showError('Not authorized to access admin dashboard');
                        submitBtn.textContent = origText;
                        submitBtn.disabled = false;
                        return;
                    }
                    console.log('[LOGIN] Admin authenticated successfully');
                    localStorage.setItem('authToken', res.json.token);
                    if(res.json.user) localStorage.setItem('authUser', JSON.stringify(res.json.user));
                    if(res.json.redirect) window.location.href = res.json.redirect;
                    else { closeModal(); location.reload(); }
                } else {
                    const msg = (res.json && (res.json.message || res.json.error)) || (res.error && res.error.message) || 'Invalid credentials';
                    console.error('[LOGIN] Failed:', msg);
                    showError(msg);
                    submitBtn.textContent = origText;
                    submitBtn.disabled = false;
                }
            });

            // Password show/hide toggles
            function initPasswordToggles(){
                document.querySelectorAll('.password-toggle').forEach(btn => {
                    btn.addEventListener('click', function(e){
                        e.preventDefault();
                        const targetId = btn.getAttribute('data-target');
                        const input = document.getElementById(targetId);
                        if(!input) return;

                        if (input.readOnly && /^[\*\u2022\.]+$/.test((input.value||'').trim())) {
                            alert('For security the password cannot be displayed. Use "Change password" to set a new password.');
                            return;
                        }

                        if(input.type === 'password'){
                            input.type = 'text';
                            btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                            btn.setAttribute('aria-label','Hide password');
                            try{ input.focus(); input.setSelectionRange(0, input.value.length); }catch(e){}
                        } else {
                            input.type = 'password';
                            btn.innerHTML = '<i class="fas fa-eye"></i>';
                            btn.setAttribute('aria-label','Show password');
                        }
                    });
                });
            }
            initPasswordToggles();

            function populateProfile(){
                try{
                    const raw = localStorage.getItem('authUser');
                    if(!raw) return;
                    const u = JSON.parse(raw);
                    document.getElementById('pfName').value = u.name || '';
                    document.getElementById('pfPhone').value = u.phone || '';
                    document.getElementById('pfEmail').value = u.email || '';
                    document.getElementById('pfPassword').value = '********';
                }catch(e){}
            }

            document.addEventListener('click', function(e){
                if(e.target && e.target.id === 'pfLogout'){
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('authUser');
                    closeModal();
                    location.reload();
                }
                if(e.target && e.target.id === 'pfClose'){
                    closeModal();
                }
            });

            // Registration removed for admin dashboard; admin users must be managed server-side
        })();
    </script>
</body>
</html>